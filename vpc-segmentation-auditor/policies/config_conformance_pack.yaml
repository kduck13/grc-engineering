# VPC Segmentation Conformance Pack
#
# This file documents the AWS Config managed rules used in this lab, grouped
# by compliance framework. It is a reference artifact - the rules themselves
# are deployed via Terraform in config_rules.tf.
#
# In a production environment, this would be deployed as an AWS Config
# conformance pack across an Organization to enforce these controls at scale.
# See: https://docs.aws.amazon.com/config/latest/developerguide/conformance-packs.html

Parameters:
  ProjectName:
    Type: String
    Default: vpc-seg-lab

# ─────────────────────────────────────────────────────────────────────────────
# CIS AWS Foundations Benchmark v1.4
# ─────────────────────────────────────────────────────────────────────────────
Resources:

  # CIS 2.9 - Ensure VPC flow logging is enabled in all VPCs
  CIS29VpcFlowLogs:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: !Sub "${ProjectName}-cis-2-9-vpc-flow-logs"
      Description: "CIS 2.9 | SOC2 CC6.6 | ISO A.12.4.1 - VPC flow logs must be enabled."
      Source:
        Owner: AWS
        SourceIdentifier: VPC_FLOW_LOGS_ENABLED

  # CIS 5.2 - Ensure no security groups allow ingress from 0.0.0.0/0 to port 22
  CIS52RestrictSsh:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: !Sub "${ProjectName}-cis-5-2-restrict-ssh"
      Description: "CIS 5.2 | SOC2 CC6.1 | ISO A.9.4.2 - SSH must not be open to the internet."
      Source:
        Owner: AWS
        SourceIdentifier: RESTRICTED_INCOMING_TRAFFIC
      InputParameters:
        blockedPort1: "22"

  # CIS 5.3 - Ensure no security groups allow ingress from 0.0.0.0/0 to port 3389
  CIS53RestrictRdp:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: !Sub "${ProjectName}-cis-5-3-restrict-rdp"
      Description: "CIS 5.3 | SOC2 CC6.1 | ISO A.9.4.2 - RDP must not be open to the internet."
      Source:
        Owner: AWS
        SourceIdentifier: RESTRICTED_INCOMING_TRAFFIC
      InputParameters:
        blockedPort1: "3389"

  # CIS 1.16 - Ensure IAM policies that allow full administrative privileges are not attached
  CIS116NoAdminWildcard:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: !Sub "${ProjectName}-cis-1-16-no-admin-wildcard"
      Description: "CIS 1.16 | SOC2 CC6.3 | ISO A.9.4.1 - IAM policies must not grant wildcard admin access."
      Source:
        Owner: AWS
        SourceIdentifier: IAM_POLICY_NO_STATEMENTS_WITH_ADMIN_ACCESS

# ─────────────────────────────────────────────────────────────────────────────
# Additional network controls (SOC2 / ISO 27001)
# ─────────────────────────────────────────────────────────────────────────────

  # SOC2 CC6.6 / ISO A.13.1.1 - EC2 instances should not have public IPs
  NoPublicIpOnEc2:
    Type: AWS::Config::ConfigRule
    Properties:
      ConfigRuleName: !Sub "${ProjectName}-no-public-ip-ec2"
      Description: "SOC2 CC6.6 | ISO A.13.1.1 - EC2 instances must not have public IP addresses."
      Source:
        Owner: AWS
        SourceIdentifier: EC2_INSTANCE_NO_PUBLIC_IP

# ─────────────────────────────────────────────────────────────────────────────
# Controls covered by the Python scanner but not by managed Config rules
#
# These require custom logic that AWS managed rules do not provide:
#   - VPC peering authorization tags (no managed rule exists)
#   - Unrestricted egress on security groups (no managed rule exists)
#   - Wildcard IAM on instance roles specifically (broader than CIS 1.16)
#
# The scanner in scripts/scanner.py fills this gap with boto3-based checks.
# ─────────────────────────────────────────────────────────────────────────────
